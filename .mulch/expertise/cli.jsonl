{"type":"convention","content":"When sibling builder branches have cross-file dependencies (e.g., CLI router imports commands created on another branch), the reviewer cannot run full quality gates in isolation. Merge order matters: the branch creating new modules must be merged before the branch importing them.","classification":"tactical","recorded_at":"2026-02-19T20:57:26.673Z","id":"mx-df7356"}
{"type":"pattern","name":"multi-feature-decomposition","description":"Lead agent orchestration for multi-feature startup: decompose into 4 parallel builders with non-overlapping file scopes, then spawn a 5th integration builder for cross-cutting CLI routing changes. Send merge_ready per-builder as each reviewer passes rather than batching.","classification":"tactical","recorded_at":"2026-02-19T20:57:32.560Z","id":"mx-8b0ca7"}
{"type":"convention","content":"Builder task may arrive with a spec describing a bug that has already been fixed by a sibling branch merged before the worktree was created. Always audit the actual file state against the spec before making changes. If the fix is already in place, report no-op completion.","classification":"tactical","recorded_at":"2026-02-19T21:00:34.227Z","evidence":{"bead":"legio-zpw"},"id":"mx-837529"}
{"type":"convention","content":"agentColor().dot returns bg-* Tailwind classes designed for CSS circles (empty spans with rounded-full). For text characters like ● use .text instead (text-* classes). Colors.dot is for backgrounds, colors.text is for text color.","classification":"tactical","recorded_at":"2026-02-19T21:01:36.902Z","id":"mx-9fc7a4"}
{"type":"convention","content":"When parallel builders import functions from another builder's unmerged branch, merge order matters. The dependency branch (providing exports) must merge before the consumer branch. Reviewers should check import existence against main.","classification":"tactical","recorded_at":"2026-02-19T21:01:38.866Z","id":"mx-909dd4"}
{"type":"convention","content":"Biome check from within a .legio/worktree always returns 'Checked 0 files' because biome.json ignores .legio/. Lint verification for worktree code requires running from the canonical repo root.","classification":"tactical","recorded_at":"2026-02-19T21:01:41.253Z","id":"mx-830cc1"}
{"type":"convention","content":"README-only tasks (no code changes) will have pre-existing quality gate failures from in-flight sibling branches; these are not caused by README edits and should be noted in the result mail without blocking completion.","classification":"tactical","recorded_at":"2026-02-19T21:57:53.384Z","id":"mx-8e771d"}
{"type":"convention","content":"Typecheck errors in sibling-owned files (outside FILE_SCOPE) are pre-existing from parallel builder branches and do not block the current builder's quality gate. Only errors in your own scoped files matter.","classification":"tactical","recorded_at":"2026-02-20T08:27:11.416Z","evidence":{"bead":"legio-uwc"},"id":"mx-e0925e"}
{"type":"convention","content":"When testing EADDRINUSE with two HTTP servers on macOS, use explicit '127.0.0.1' instead of 'localhost' as the host. On macOS, dns.lookup('localhost') can return either 127.0.0.1 or ::1 across different calls, causing the two servers to bind to different address families and not conflict, making the EADDRINUSE test pass spuriously.","classification":"tactical","recorded_at":"2026-02-20T08:31:08.432Z","evidence":{"bead":"legio-47m"},"id":"mx-57d6d4"}
{"type":"convention","content":"Strategy view (and other self-fetching views like autopilot) don't need initData() pre-fetch in app.js; they use their own useEffect to fetch data on mount, keeping the app.js fetch list stable.","classification":"tactical","recorded_at":"2026-02-20T09:31:54.273Z","id":"mx-a574e7"}
{"type":"convention","content":"When reviewing frontend browser JS views in worktrees, biome lint cannot run (biome ignores .legio/ dirs). Manually verify against existing view file conventions (issues.js, costs.js) as the substitute quality gate.","classification":"tactical","recorded_at":"2026-02-20T09:31:57.206Z","id":"mx-171407"}
{"type":"pattern","name":"multi-builder-feature-orchestration","description":"Lead orchestration pattern for multi-builder feature: 2 scouts (server/UI + types/agent), 3 builders with non-overlapping file scope (agent-def, types+routes+tests, view+app), 1 reviewer per builder, merge_ready sent per-builder as each passes review.","classification":"tactical","recorded_at":"2026-02-20T09:32:11.630Z","id":"mx-6344fa"}
{"type":"decision","title":"CTO outputs strategy.json not bd create","rationale":"CTO agent should produce structured recommendations as a JSON file (.legio/strategy.json) rather than creating beads issues directly. This enables a human approval workflow via the web UI Strategy view, where recommendations render as cards with approve/dismiss buttons. Approving creates the beads issue via POST /api/strategy/:id/approve.","classification":"tactical","recorded_at":"2026-02-20T09:32:18.719Z","id":"mx-b7d051"}
{"type":"failure","description":"Merge commit 584d078 (legio/commandview-builder/legio-9g0) corrupted src/server/public/views/command.js by mashing two incompatible UI architectures (unified conversational vs two-panel mission-control). Result: 5+ undefined references (agentColor, ActivityTimeline, CoordinatorChat, ActivityCard, typeBadgeClass) causing total UI crash on load.","resolution":"Reverted command.js to pre-merge version (90d906a). For future: browser JS views with no type checking are high-risk merge targets. Reviewers should verify merged JS output loads in a browser, especially for full-file rewrites.","classification":"tactical","recorded_at":"2026-02-20T09:50:36.165Z","evidence":{"commit":"584d078"},"id":"mx-8b812e"}
{"type":"convention","content":"POST routes for parameterized paths like /api/strategy/:id/approve go before the 'if (request.method \\!== GET)' guard in routes.ts. GET counterparts go in the GET section after audit routes. Use block scope {} + matchRoute() for parameterized POST routes.","classification":"tactical","recorded_at":"2026-02-20T09:24:55.108Z","evidence":{"bead":"legio-0p6"},"id":"mx-2cdda2"}
{"type":"convention","content":"vitest test files that test external CLI tools (bd, legio) should mock the client module with vi.mock() to avoid PATH dependency in test environment. For beads client: mock createBeadsClient() to return fake client with list/ready returning [], show throwing, create returning a predictable ID. This keeps existing tests passing while enabling new tests.","classification":"tactical","recorded_at":"2026-02-20T09:25:00.837Z","evidence":{"bead":"legio-0p6"},"id":"mx-183efe"}
{"type":"convention","content":"Frontend browser JS views (app.js, views/*.js) in worktrees: biome cannot lint them, typecheck does not apply, and test failures in sibling-owned files are pre-existing. Quality gate for these files is verified manually (correct structure, no broken imports/routes).","classification":"tactical","recorded_at":"2026-02-20T10:20:08.465Z","evidence":{"bead":"legio-7at"},"id":"mx-285363"}
{"type":"convention","content":"When a prior builder's merge is reverted due to file corruption, the next builder rebuilding the same component may simplify the implementation rather than exactly recreating the reverted version. Reviewers should evaluate against acceptance criteria, not exact parity with the reverted state.","classification":"tactical","recorded_at":"2026-02-20T10:37:42.473Z","id":"mx-0efbc0"}
{"type":"convention","content":"biome check exits with code 1 (not 0) when run from within a .legio/worktree that is fully ignored — 'No files were processed' is an error in newer biome versions. Lint gate is satisfied by manually verifying import order; biome cannot check worktree files.","classification":"tactical","recorded_at":"2026-02-20T10:36:48.867Z","evidence":{"bead":"legio-zh3"},"id":"mx-378ec9"}
{"type":"convention","content":"JSONL conflict resolution in tryAutoResolve: resolveJsonlConflict() collects lines from all conflict sides plus non-conflict sections, parses as JSON (returning null on any parse failure to fall through), deduplicates by id keeping later recorded_at, sorts ascending by recorded_at, appends no-id records at end. Exported for unit testing. tryAutoResolve dispatches via file.endsWith('.jsonl').","classification":"tactical","recorded_at":"2026-02-20T10:37:02.965Z","evidence":{"bead":"legio-zh3"},"id":"mx-0a3acf"}
{"type":"convention","content":"Frontend JS views in src/server/public/views/ cannot be biome-checked from worktrees (biome ignores .legio/). Quality gate for lint is effectively skipped for browser-only JS files in worktrees — treat as passing if code follows existing file conventions.","classification":"tactical","recorded_at":"2026-02-20T09:22:30.237Z","evidence":{"bead":"legio-zzh"},"id":"mx-852c50"}
{"type":"convention","content":"New view integration in app.js requires 3 changes: (1) import at top after existing view imports, (2) case in Router switch, (3) entry in NAV_LINKS array. Strategy view follows issues.js filter button pattern with orange active/gray inactive style.","classification":"tactical","recorded_at":"2026-02-20T09:22:40.955Z","evidence":{"bead":"legio-zzh"},"id":"mx-7ae1a9"}
{"type":"convention","content":"GET /api/coordinator/status route uses resolveTerminalSession(legioDir, projectRoot, 'coordinator'). Returns { state: 'running' | 'stopped', tmuxSession? }. Non-null tmuxSession → running, null → stopped. Route placed in the GET-only section after /api/status.","classification":"tactical","recorded_at":"2026-02-20T11:08:23.545Z","id":"mx-306ab4"}
{"type":"convention","content":"routes.test.ts: sessions.bead_id is NOT NULL constrained — cannot pass beadId: null when seeding coordinator sessions in tests. Use a dummy string like 'coord-task' instead.","classification":"tactical","recorded_at":"2026-02-20T11:08:28.549Z","id":"mx-5755a9"}
